---
title: "Лабораторная работа №2"
author: "Марковский В.А."
date: "12 12 2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

``` {r, echo=FALSE, include = FALSE}
##Загрузка данных
library('Hmisc') # Пакет для расчёта корреляционной матрицы
library('knitr') # Пакет для генерации отчёта
DF <- read.table('R_Dannye_Markovskiy.csv',
                 header = T,       # Pаголовок в первой строке                  
                 dec = ',',        # Разделитель целой и дробной части                  
                 sep = ';',        # Разделитель значений в строке                  
                 row.names = 2,    # Первый столбец – названия наблюдений                  
                 as.is = T,              # Отсутствие факторов                  
                 na.strings = 'NA')      # Символы пропущенных значений 
DF$fo <- as.factor(DF$fo)
reg.df <- DF[, -2]            #Записываем только переменные
reg.df <- na.omit(reg.df)     #Очищаем данные от пропущенных значений
reg.df
#ЦФО - CFD, СЗФО - NWFD, ЮФО - SFD, СКФО - NCFD, ПФО - VFD, УФО - UFD, СФО - NFD, ДВФО - FEFD
```

## Список столбцов файла:
* ```fo``` - название федерального округа
* ```iso_code``` - код региона субъекта РФ
* ```region``` - название субъекта РФ
* ```Y``` - Объем отгруженных товаров собственного производства, выполненных работ и услуг собственными силами по видам экономической деятельности: обрабатывающие производства за 2014 год, млн. руб
* ```X1``` - Индексы цен производителей промышленных товаров по видам экономической деятельности: обрабатывающие производства за 2014 год, в % (декабрь к декабрю предыдущего года)
* ```X2``` -  Изменение среднегодовой численности занятых за 2014 год, в % к предыдущему году
* ```X3``` - Индекс физического объема ВРП за 2013 год, в постоянных ценах в % к предыдущему году
* ```X4``` - Сумма убытка организаций по отдельным видам экономической деятельности: обрабатывающие производства за 2013 год, млн руб

Данные по пяти показателям по обрабатывающим производствам за 2013-2014 гг. по регионам РФ (`r length(reg.df$Y)` наблюдения). Данные собраны из файлов, загруженных из базы Росстата [https://www.gks.ru/folder/210/document/13204](https://www.gks.ru/folder/210/document/13204) 19 октября 2019 года.
После загрузки файлы, каждый за отдельный год, были объединены в одну таблицу. Пропущенные наблюдения обозначить как NA.

```{r, echo = FALSE, include = FALSE}
#Оценка параметров модели
fit.1 <- lm(Y ~ X1 + X2 + X3 + X4, data = reg.df)
#Сводка по построенной модели
round(summary(fit.1)$coef, 4)
#В этой модели X3 обладает наибольшим p-значением равным 0,9212 > 0,05, поэтому его стоит исключить
#Модель без X3
fit.2 <- lm(Y ~ X1 + X2 + X4, data = reg.df) 
#Выводит только таблицу с коэффициентами
round(summary(fit.2)$coef, 4)
#X1 обладает наибольшим p-значение равным 0,839 > 0,05, поэтому его стоит исключить
#Модель без X3 и X1
fit.3 <- lm(Y ~ X2 + X4, data = reg.df)
#Сводка по построенной модели
round(summary(fit.3)$coef, 4)
#Константа обладает наибольшим p-значением (0,131), поэтому ее стоит исключить
#Исключение константы имеет экономический смысл, так как Y - объём отгруженных товаров в млн руб
# X2 - Изменение среднегодовой численности рабочих в % к предыдущему году (0% - нет рабочих в экономике)
# X4 - сумма убытков, млн руб
# Получается, что если Y=0 при нулевой сумме X2 и X4 имеет экономический смысл
#Модель без константы
fit.X4 <- lm(Y ~ X4, data = reg.df)
#Сводка по построенной модели
summary(fit.X4)
#Все элементы подели значимы
#Уравнение в целом значимо, p-значение = 2,2e-16
```

``` {r, include = FALSE, echo = FALSE}
#Построение моделей с фиктивной переменной
fit.X4.fo <- lm(Y ~ fo * X4, data = reg.df)
#Сводка по построенной модели
summary(fit.X4.fo)
#Уравнение в целом значимо, p-значение = 2,2e-16

#Создаем фрейм со всеми переменными-факторами (создаем фиктивные)
X.matrix <- model.matrix(Y ~ X4 * fo, data = reg.df)
#Присоединяем независимую переменную
data.fit <- cbind(Y = reg.df$Y, data.frame(X.matrix)[, -1]) 
#Загружаем функцию с последовательным исключением аномальных
source('removeFactorsByPValue.R')
#Доводим до значимости
fit.X4.fo <- removeFactorsByPValue(data = data.fit, y.var.name = 'Y')
#Сводка по получанной модели
summary(fit.X4.fo)
#Уравнение в целом значимо, p-значение = 2,2e-16, а коэффициент детерминации возрос на 14% (до 86%)
```

## Сравнение нескольких моделей по качеству
```{r, echo = FALSE}
kable(round(anova(fit.X4, fit.X4.fo),2))
```

## Вывод по сравнению нескольких моделей по качеству
Видно, что для двух рассматриваемых факторов добавление фиктивных переменных уменьшает остаточную дисперсию (RSS) и тем самым значимо повышает качество моделей (p-значение меньше 0,05).

## Таблица с характеристиками качества моделей
```{r, echo = FALSE}
#Список построенных моделей
models.list <- list(fit.X4, fit.X4.fo)
#Наименования моделей
names(models.list) <- c('fit.X4', 'fit.X4.fo')
#Создаем фрейм под характеристики двух моделей
df.goodness.of.fit <- data.frame(Model = names(models.list),
                                       R.2.adj = rep(0, length(models.list)),
                                       F.calc = rep(0, length(models.list)),
                                       Avg.Appr.Err = rep(0, length(models.list)))

#Заполняем созданный нами фрейм с помощью цикла for
for(i in 1:length(models.list)){
  #Скорректированный R-квадрат
  df.goodness.of.fit[i, 'R.2.adj'] <-  round(summary(models.list[[i]])$adj.r.squared, 3)
   #F расчетное
  df.goodness.of.fit[i, 'F.calc'] <-  round(summary(models.list[[i]])$fstatistic[1], 2)
  #Средняя ошибка аппроксимации
  df.goodness.of.fit[i, 'Avg.Appr.Err'] <-            
    round(sum(abs((residuals(models.list[[i]]))/reg.df$Y))/length(reg.df$Y)*100, 1)  
}
#Таблица с нужными нам характеристиками
kable(df.goodness.of.fit)
```

```{r, echo = FALSE, include = FALSE}
rm(i, df.goodness.of.fit, data.fit, X.matrix, fit.1, fit.2, fit.3,
   removeFactorsByPValue)
summary(fit.X4.fo)
save.image('Example_Economy.RData')
```

## Вывод
Судя по таблице с характеристиками качества моделей видно, что лучшей моделью является fit.X2_X4.fo, с фиктивными переменными, так как имеет наибольший скорректированный R-квадрат, а так же наименьшую среднюю ошибку аппроксимации.
#ЦФО - CFD, СЗФО - NWFD, ЮФО - SFD, СКФО - NCFD, ПФО - VFD, УФО - UFD, СФО - NFD, ДВФО - FEFD

* ```Y``` - Объем отгруженных товаров собственного производства, выполненных работ и услуг собственными силами по видам экономической деятельности: обрабатывающие производства за 2014 год, млн. руб
* ```X2``` -  Изменение среднегодовой численности занятых за 2014 год, в % к предыдущему году
* ```X4``` - Сумма убытков организаций (обрабатывающие производства)

Получаем, что константа:
    * При принадлежности к ЦФО, ДВФО, СКФО, ЮФО и СЗФО константы положительно и примерно равны равны 1.28*10^7
    * В случае других округов, константа имеет другой знак
Константа не имеет экономического смысла. 

X2 - Изменение среднегодовой численности занятых (в % к предыдущему году)
    * При принадлежности к СФО, УФО и ПФО: коэффициенты приблизительно равен 1.3*10^5
    * В остальных случаях коэффициент равен 0
При ненулевом коэффициенте можно объяснить так: при увеличении численности занятых на 1% объём отгруженных товаров увеличивается на 1.3*10^5 млн рублей в данных регионах. 

X4 - Сумма убытков организаций:
    * При принадлежности к СФО и УФО: коэффициенты при Х4 равны -35,5 и -48,9 соотвественно. (в млн рубл)
    * В остальных регионах коэффициент равен 58,5
    
Можно объяснить это следующим образом, при отрицательных коэффициентах: убытки негативно сказываются на объёме отгруженных товаров. То есть, скорее всего, убыточные предприятия в этих регионах закрываются или сокращают производства.
При положительном коэффициенте, суммы убытков увеличивают объём отгруженных товаров. Можно предположить, что убытки объясняются инвестициями в производство и попытки расширения присутствия на рынке. 


