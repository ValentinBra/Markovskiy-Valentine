---
title: "Лабораторная работа №2"
author: "Марковский Валентин Александрович"
date: "25 12 2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

``` {r, echo=FALSE, include = FALSE}
##Загрузка данных
library('Hmisc') # Пакет для расчёта корреляционной матрицы
library('knitr') # Пакет для генерации отчёта
DF <- read.table('R_Dannye_Markovskiy.csv',
                 header = T,       # Pаголовок в первой строке                  
                 dec = ',',        # Разделитель целой и дробной части                  
                 sep = ';',        # Разделитель значений в строке                  
                 row.names = 2,    # Первый столбец – названия наблюдений                  
                 as.is = T,              # Отсутствие факторов                  
                 na.strings = 'NA')      # Символы пропущенных значений 
DF$fo <- as.factor(DF$fo)
reg.df <- DF[, -2]            #Записываем только переменные
reg.df <- na.omit(reg.df)     #Очищаем данные от пропущенных значений
```

## Изначальная модель

Модель 0: $Y = -3729953,7 + 4,858 \cdot X1 + 41023,16 \cdot X2 -7309,5 \cdot X3 + 3,5 \cdot X4$

## Список столбцов файла:
* ```fo``` - название федерального округа
* ```iso_code``` - код региона субъекта РФ
* ```region``` - название субъекта РФ
* ```Y``` - Объем отгруженных товаров собственного производства, выполненных работ и услуг собственными силами по видам экономической деятельности: обрабатывающие производства за 2014 год
* ```X1``` - Индексы цен производителей промышленных товаров по видам экономической деятельности: обрабатывающие производства за 2014 год
* ```X2``` - Изменение среднегодовой численности занятых за 2014 год
* ```X3``` - Индекс физического объема ВРП за 2013 год
* ```X4``` - Сумма убытка организаций по отдельным видам экономической деятельности: обрабатывающие производства за 2013 год

Данные по пяти показателям по обрабатывающим производствам за 2013-2014 гг. по регионам РФ. Данные собраны из файлов, загруженных из базы Росстата [https://www.gks.ru/folder/210/document/13204](https://www.gks.ru/folder/210/document/13204) 25 декабря 2020 года.
После загрузки файлы, каждый за отдельный год, были объединены в одну таблицу. Пропущенные наблюдения обозначить как NA.

### Раздел 1

```{r, echo = FALSE, include = FALSE}
#Оценка параметров модели
fit.1 <- lm(Y ~ X1 + X2 + X3 + X4, data = reg.df)
#Сводка по построенной модели
round(summary(fit.1)$coef, 4)
# В этой модели X3 обладает наибольшим p-значением = 0.6249 > 0.05, поэтому исключим его
#Оценка параметров модели без X3
fit.2 <- lm(Y ~ X1 + X2 + X4, data = reg.df)
#Сводка по построенной модели
round(summary(fit.2)$coef, 4)
# В этой модели X1 обладает наибольшим p-значением = 0.5175 > 0.05, поэтому исключим его
#Оценка параметров модели без X1
fit.3 <- lm(Y ~ X2 + X4, data = reg.df)
#Сводка по построенной модели
round(summary(fit.3)$coef, 4)
# В этой модели X2 обладает наибольшим p-значением = 0.4528 > 0.05, поэтому исключим его
#Оценка параметров модели без X2
fit.X4 <- lm(Y ~ X4, data = reg.df)
#Сводка по построенной модели
round(summary(fit.X4)$coef, 4)
# Все параметры данной модели являются не значимыми, так же как и уравнение в целом (Из графика корреляции ЛР1 Y не имеет линейной связи ни с одним X)

# Модель с переменной структурой
fit.X4.fo <- lm(Y ~ fo * X4, data = reg.df)
# Сводка по построенной модели
summary(fit.X4.fo)
# В целом уравнение значимо, p-значение = 7.397e-05 < 0.05

# Создаем фрейм со всеми переменными-факторми (создаем фиктивные)
X.matrix <- model.matrix(Y ~ fo * X4, data = reg.df)
# Присоединяем независимую переменную
data.fit <- cbind(Y = reg.df$Y, data.frame(X.matrix)[, -1])
#Загружаем функцию с последовательным исключением аномальных
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')
#Доводим до значимости
fit.X4.fo <- removeFactorsByPValue(data = data.fit, y.var.name = 'Y')
#Сводка по получанной модели
summary(fit.X4.fo)
# Все элементы построенной модели значимы
# Уравнение в целом является значимым, p-значение = 2.382e-08
```

## Сравнение нескольких моделей по качеству
**Модели с фактором X4**
```{r, echo = FALSE}
#Модели с фактором X4
table1 <- anova(fit.X4, fit.X4.fo)
kable(table1)
```

## Вывод по сравнению нескольких моделей по качеству
Видно, что для рассматриваемого фактора добавление фиктивных переменных уменьшает остаточную дисперсию (RSS) и тем самым значимо повышает качество моделей (p-значение меньше 0,05)

## Таблица с характеристиками качества моделей
```{r, echo = FALSE}
#Список построенных моделей
models.list <- list(fit.X4, fit.X4.fo)
#Наименования моделей
names(models.list) <- c('fit.X4', 'fit.X4.fo')
#Создаем фрейм под характеристики двух моделей
df.goodness.of.fit <- data.frame(Модель = names(models.list),
                                       R.2.скорр = rep(0, length(models.list)),
                                       F.расч = rep(0, length(models.list)),
                                       Ср.ошибка.Аппрокс = rep(0, length(models.list)))
#Заполняем созданный нами фрейм с помощью цикла for
for(i in 1:length(models.list)){
  df.goodness.of.fit[i, 'R.2.скорр'] <-                    #Скорректированный R-квадрат
    round(summary(models.list[[i]])$adj.r.squared, 3)
  df.goodness.of.fit[i, 'F.расч'] <-                       #F расчетное
    round(summary(models.list[[i]])$fstatistic[1], 2)
  df.goodness.of.fit[i, 'Ср.ошибка.Аппрокс'] <-            #Средняя ошибка аппроксимации
    round(sum(abs((residuals(models.list[[i]]))/reg.df$Y))/length(reg.df$Y)*100, 1)  
}
#Таблица с нужными нам характеристиками
kable(df.goodness.of.fit)
```

## Вывод
Судя по таблице с характеристиками качества моделей видно, что лучшей моделью является fit.X4.fo, c фиктивными переменными, так как имеет наибольший скорректированный R-квадрат, а так же наименьшую среднюю ошибку аппроксимации.

### Раздел 2

```{r, echo = FALSE}
reg.df.log <- reg.df

reg.df.log$Y <- log(reg.df$Y)
reg.df.log$X1 <- log(reg.df$X1)
reg.df.log$X2 <- log(reg.df$X2)
reg.df.log$X3 <- log(reg.df$X3)
reg.df.log$X4 <- log(reg.df$X4)
```

```{r, echo = FALSE, include = FALSE}
#Оценка параметров модели
fit.log.1 <- lm(Y ~ X1 + X2 + X3 + X4, data = reg.df.log)
#Сводка по построенной модели
round(summary(fit.log.1)$coef, 4)
#В этой модели X3 обладает наибольшим p-значением = 0.7903 > 0.05, поэтому исключим его
#Оценка параметров модели без X3
fit.log.2 <- lm(Y ~ X1 + X2 + X4, data = reg.df.log)
#Сводка по построенной модели
round(summary(fit.log.2)$coef, 4)
#В этой модели X2 обладает наибольшим p-значением = 0.3907 > 0.05, поэтому исключим его
#Оценка параметров модели без X2
fit.log.3 <- lm(Y ~ X1 + X4, data = reg.df.log)
#Сводка по построенной модели
round(summary(fit.log.3)$coef, 4)
#В этой модели X1 обладает наибольшим p-значением = 0.1316 > 0.05, поэтому исключим его
#Оценка параметров модели без X1
fit.log.X4 <- lm(Y ~ X4, data = reg.df.log)
#Сводка по построенной модели
round(summary(fit.log.X4)$coef, 4)
##Все параметры данной модели являются не значимыми, так же как и уравнение в целом (p-значение = 0.05996)

#Модель с переменной структурой
fit.log.X4.fo <- lm(Y ~ fo * X4, data = reg.df.log)
#Сводка по построенной модели
summary(fit.log.X4.fo)
#В целом уравнение значимо, p-значение = 1.203e-06 < 0.05

#Создаем фрейм со всеми переменными-факторами (создаем фиктивные)
X.matrix.log <- model.matrix(Y ~ X4 * fo, data = reg.df.log)
#Присоединяем независимую переменную
data.fit.log <- cbind(Y = reg.df.log$Y, data.frame(X.matrix.log)[, -1])
#Загружаем функцию с последовательным исключением аномальных
source('https://raw.githubusercontent.com/aksyuk/R-Practice-basics/master/user_functions/removeFactorsByPValue.R')
#Доводим до значимости
fit.log.X4.fo <- removeFactorsByPValue(data = data.fit.log, y.var.name = 'Y')
#Сводка по получанной модели
summary(fit.log.X4.fo)
#Все элементы построенной модели значимы
#Уравнение в целом является значимым, p-значение = 1.888e-08
```

## Сравнение нескольких моделей по качеству (с исходными данными и прологарифмированными)
**Модели с фактором X4**
```{r, echo = FALSE}
#Модели с факторам X4
table2 <- anova(fit.X4, fit.X4.fo, fit.log.X4, fit.log.X4.fo)
kable(table2)
```

## Вывод по сравнению нескольких моделей по качеству
Видно, что для рассматриваемого фактора добавление фиктивных переменных уменьшает остаточную дисперсию (RSS) и тем самым значимо повышает качество моделей (p-значение меньше 0,05)

## Таблица с характеристиками качества моделей
```{r, echo = FALSE}
#Список построенных моделей
models.list <- list(fit.log.X4, fit.log.X4.fo)
#Наименования моделей
names(models.list) <- c('fit.log.X4', 'fit.log.X4.fo')
#Создаем фрейм под характеристики двух моделей
df.goodness.of.fit.log <- data.frame(Модель = names(models.list),
                                       R.2.скорр = rep(0, length(models.list)),
                                       F.расч = rep(0, length(models.list)),
                                       Ср.ошибка.Аппрокс = rep(0, length(models.list)))
#Заполняем созданный нами фрейм с помощью цикла for
for(i in 1:length(models.list)){
  df.goodness.of.fit.log[i, 'R.2.скорр'] <-                    #Скорректированный R-квадрат
    round(summary(models.list[[i]])$adj.r.squared, 3)
  df.goodness.of.fit.log[i, 'F.расч'] <-                       #F расчетное
    round(summary(models.list[[i]])$fstatistic[1], 2)
  df.goodness.of.fit.log[i, 'Ср.ошибка.Аппрокс'] <-            #Средняя ошибка аппроксимации
    round(sum(abs((residuals(models.list[[i]]))/reg.df.log$Y))/length(reg.df.log$Y)*100, 1)  
}
#Таблица с нужными нам характеристиками
kable(df.goodness.of.fit)
kable(df.goodness.of.fit.log)
```

## Вывод
Судя по таблице с характеристиками качества моделей видно, что лучшими моделями являются fit.X4.fo (с исходными данными) и fit.log.X4.fo (с прологарифмированными данными), c фиктивными переменными, так как имеет наибольший скорректированный R-квадрат, а так же наименьшую среднюю ошибку аппроксимации.

```{r, echo = FALSE, include = FALSE}
rm(i, df.goodness.of.fit, df.goodness.of.fit.log, data.fit, data.fit.log, X.matrix, X.matrix.log, fit.1, fit.2, fit.3, fit.X4, table1, table2,
   removeFactorsByPValue, fit.log.1, fit.log.2, fit.log.3, fit.log.X4, models.list)
save.image('R_Dannye_Markovskiy.RData')
```